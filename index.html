} else {
                        event.target.value = '';
                    }
                } else {
                    alert('密碼錯誤，無法更換圖片。');
                    event.target.value = '';
                }
            }

            // 讀取目前菜單圖片與 Storage 中的菜單檔案列表
            function loadMenuImage() {
                db.collection("images").doc("menuImage").get()
                .then((doc) => {
                    if (doc.exists && doc.data().url) {
                        document.getElementById('menuImage').src = doc.data().url;
                        document.getElementById('imageSelector').value = doc.data().url;
                    } else {
                        document.getElementById('menuImage').src = 'https://via.placeholder.com/400x300?text=尚未上傳菜單';
                    }
                })
                .catch((error) => {
                    console.error("Error loading menu image: ", error);
                    alert("載入菜單圖片失敗");
                });

                storage.ref('menu').listAll()
                .then((result) => {
                    const selector = document.getElementById('imageSelector');
                    selector.innerHTML = '<option value="">選擇圖片</option>';
                    result.items.forEach((imageRef) => {
                        imageRef.getDownloadURL().then((url) => {
                            const option = document.createElement('option');
                            option.value = url;
                            option.textContent = imageRef.name;
                            selector.appendChild(option);
                        });
                    });
                })
                .catch((error) => {
                    console.error("Error loading images: ", error);
                    alert("載入菜單列表失敗");
                });
            }

            // 載入刪除菜單下拉式選單
            function loadDeleteMenuList() {
                const deleteSelector = document.getElementById('deleteMenuSelector');
                deleteSelector.innerHTML = '<option value="">選擇要刪除的菜單</option>';
                
                storage.ref('menu').listAll()
                .then((result) => {
                    result.items.forEach((imageRef) => {
                        const option = document.createElement('option');
                        option.value = imageRef.name;
                        option.textContent = imageRef.name;
                        deleteSelector.appendChild(option);
                    });
                })
                .catch((error) => {
                    console.error("取得菜單列表時發生錯誤: ", error);
                    alert("載入菜單列表失敗");
                });
            }

            // 導出訂單為 Excel 檔案 (XLSX格式，支援顏色)
            function exportToExcel() {
                // 先加載 SheetJS 庫
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                script.onload = function() {
                    // 獲取所有訂單數據直接從數據庫
                    db.collection("orders").get().then((querySnapshot) => {
                        const orders = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                            .sort((a, b) => b.timestamp - a.timestamp);
                        
                        // 創建工作表
                        const ws = XLSX.utils.aoa_to_sheet([
                            ["No.", "已繳費", "姓名", "餐點", "價格", "訂購時間", "備註"]
                        ]);
                        
                        // 添加數據行
                        orders.forEach((order, index) => {
                            const orderDate = new Date(order.timestamp);
                            const dateTimeString = orderDate.toLocaleString('zh-TW', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: false
                            });
                            
                            // 使用 "已繳費" 或 "未繳費" 文字
                            const paidStatus = order.isPaid ? "已繳費" : "未繳費";
                            
                            // 往工作表添加一行
                            XLSX.utils.sheet_add_aoa(ws, [[
                                index + 1,
                                paidStatus,
                                order.name,
                                order.meal,
                                `${order.price.toFixed(2)}`,
                                dateTimeString,
                                order.note || ''
                            ]], { origin: -1 });
                            
                            // 獲取當前行號
                            const rowIndex = index + 2; // 加2是因為標題行(1)和基於0的索引
                            
                            // 為"已繳費"單元格添加樣式
                            const cellRef = XLSX.utils.encode_cell({r: rowIndex-1, c: 1}); // B列
                            if (!ws['!cols']) ws['!cols'] = [];
                            if (!ws['!rows']) ws['!rows'] = [];
                            
                            // 設置顏色
                            if (!ws[cellRef].s) ws[cellRef].s = {};
                            ws[cellRef].s = {
                                font: {
                                    color: { rgb: order.isPaid ? "0000FF" : "FF0000" } // 藍色或紅色
                                }
                            };
                        });
                        
                        // 創建工作簿
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, "訂單列表");
                        
                        // 設置列寬
                        ws['!cols'] = [
                            { wch: 5 },   // No.
                            { wch: 8 },   // 已繳費
                            { wch: 10 },  // 姓名
                            { wch: 15 },  // 餐點
                            { wch: 10 },  // 價格
                            { wch: 18 },  // 訂購時間
                            { wch: 20 }   // 備註
                        ];
                        
                        // 生成檔案名稱
                        const currentDate = new Date().toLocaleDateString('zh-TW').replace(/\//g, '-');
                        const fileName = `訂單_${currentDate}.xlsx`;
                        
                        // 導出為XLSX
                        XLSX.writeFile(wb, fileName);
                        alert('訂單已成功導出為Excel檔案！');
                    }).catch((error) => {
                        console.error("導出訂單時出錯: ", error);
                        alert("導出訂單失敗，請稍後再試。");
                    });
                };
                
                script.onerror = function() {
                    alert("無法載入Excel導出工具，請檢查網絡連接。");
                };
                
                document.head.appendChild(script);
            }

            // 清除所有訂單
            function clearAllOrders() {
                if (confirm('確定要清除所有訂單嗎？此操作無法撤銷。')) {
                    db.collection("orders").get().then((querySnapshot) => {
                        querySnapshot.forEach((doc) => {
                            doc.ref.delete();
                        });
                        alert('所有訂單已成功清除！');
                    }).catch((error) => {
                        console.error("清除訂單時出錯: ", error);
                        alert("清除訂單失敗，請稍後再試。");
                    });
                }
            }

            // 刪除選取的訂單
            function deleteSelectedOrders() {
                const checkboxes = document.querySelectorAll('#orderTable input[type="checkbox"]:checked');
                if (checkboxes.length === 0) {
                    alert('請先選擇要刪除的訂單');
                    return;
                }
                if (confirm(`確定要刪除選中的 ${checkboxes.length} 筆訂單嗎？`)) {
                    let deleteCount = 0;
                    checkboxes.forEach((checkbox) => {
                        const orderId = checkbox.getAttribute('data-id');
                        db.collection("orders").doc(orderId).delete()
                        .then(() => {
                            deleteCount++;
                            if (deleteCount === checkboxes.length) {
                                alert(`已成功刪除 ${deleteCount} 筆訂單！`);
                            }
                        })
                        .catch((error) => {
                            console.error("刪除訂單時出錯: ", error);
                            alert("刪除訂單失敗，請稍後再試。");
                        });
                    });
                }
            }

            // 初始化事件監聽器
            function initEventListeners() {
                // 表單提交事件
                document.getElementById('orderForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    const name = this.elements['name'].value;
                    const meal = this.elements['meal'].value;
                    const price = parseFloat(this.elements['price'].value);
                    const note = this.elements['note'].value;
                    const timestamp = Date.now();
                    const isPaid = false;
                    addOrderToDatabase({ name, meal, price, note, timestamp, isPaid });
                });

                // 選擇菜單事件
                document.getElementById('imageSelector').addEventListener('change', changeImage);

                // 上傳菜單按鈕事件
                document.getElementById('changeImageButton').addEventListener('click', function() {
                    document.getElementById('fileInput').click();
                });

                // 檔案選擇事件
                document.getElementById('fileInput').addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const password = prompt('請輸入密碼以上傳菜單圖片：');
                        if (password === '0841') {
                            const storageRef = storage.ref(`menu/${file.name}`);
                            storageRef.put(file).then(() => {
                                storageRef.getDownloadURL().then(url => {
                                    db.collection("images").doc("menuImage").set({ url: url }).then(() => {
                                        document.getElementById('menuImage').src = url;
                                        alert('圖片上傳成功並已設為當前菜單！');
                                        loadMenuImage();
                                    });
                                });
                            }).catch((error) => {
                                console.error("圖片上傳失敗: ", error);
                                alert("上傳圖片失敗，請稍後再試。");
                            });
                        } else {
                            alert('密碼錯誤，無法上傳菜單圖片。');
                        }
                    }
                });

                // 刪除菜單按鈕事件
                document.getElementById('deleteMenuButton').addEventListener('click', function() {
                    const password = prompt('請輸入密碼以刪除菜單：');
                    if (password === '0841') {
                        const deleteMenuSelectorContainer = document.getElementById('deleteMenuSelectorContainer');
                        if (deleteMenuSelectorContainer.style.display === "none" || !deleteMenuSelectorContainer.style.display) {
                            deleteMenuSelectorContainer.style.display = "block";
                            loadDeleteMenuList();
                        } else {
                            deleteMenuSelectorContainer.style.display = "none";
                        }
                    } else {
                        alert('密碼錯誤，無法刪除菜單。');
                    }
                });

                // 選擇刪除菜單事件
                document.getElementById('deleteMenuSelector').addEventListener('change', function() {
                    const fileName = this.value;
                    if (!fileName) return;
                    
                    if (confirm("確定要刪除 " + fileName + " 這個菜單嗎？")) {
                        const fileRef = storage.ref('menu/' + fileName);
                        
                        // 檢查是否要刪除的是當前顯示的菜單
                        db.collection("images").doc("menuImage").get().then((doc) => {
                            if (doc.exists && doc.data().url) {
                                const currentUrl = doc.data().url;
                                
                                // 獲取要刪除菜單的URL
                                fileRef.getDownloadURL().then((deleteUrl) => {
                                    // 如果刪除的是當前顯示的菜單，則清空當前菜單
                                    if (currentUrl === deleteUrl) {
                                        db.collection("images").doc("menuImage").set({ url: "" });
                                    }
                                    
                                    // 刪除檔案
                                    return fileRef.delete();
                                }).then(() => {
                                    alert("菜單 " + fileName + " 已成功刪除！");
                                    loadDeleteMenuList();
                                    loadMenuImage();
                                    this.value = '';
                                });
                            } else {
                                // 如果沒有當前菜單，直接刪除
                                fileRef.delete().then(() => {
                                    alert("菜單 " + fileName + " 已成功刪除！");
                                    loadDeleteMenuList();
                                    loadMenuImage();
                                    this.value = '';
                                });
                            }
                        }).catch((error) => {
                            console.error("刪除菜單時發生錯誤: ", error);
                            alert("刪除失敗，請稍後再試。");
                            this.value = '';
                        });
                    } else {
                        this.value = '';
                    }
                });

                // 關閉模態視窗事件
                document.querySelector('.close').addEventListener('click', function() {
                    document.getElementById('imageModal').style.display = "none";
                });

                // 點擊模態視窗背景時也關閉它
                document.getElementById('imageModal').addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = "none";
                    }
                });

                // 點擊菜單圖片時顯示模態視窗
                document.getElementById('menuImage').addEventListener('click', function() {
                    if (!this.src || this.src === "" || this.src.includes("placeholder")) return;
                    
                    const modal = document.getElementById('imageModal');
                    const modalImg = document.getElementById('modalImage');
                    modal.style.display = "block";
                    modalImg.src = this.src;
                });

                // 導出、清除、刪除按鈕事件
                document.getElementById('exportButton').addEventListener('click', exportToExcel);
                document.getElementById('clearButton').addEventListener('click', clearAllOrders);
                document.getElementById('deleteSelectedButton').addEventListener('click', deleteSelectedOrders);
            }

            // 初始化
            updateDateTime();
            loadOrdersFromDatabase();
            loadMenuImage();
            initEventListeners();
            
            // 定時更新日期時間
            setInterval(updateDateTime, 60000);
        });
    </script>
</body>

</html>
